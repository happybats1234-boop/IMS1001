import React, { useState, useMemo } from 'react';
import { base44 } from "@/api/base44Client";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Badge } from "@/components/ui/badge";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";
import { Textarea } from "@/components/ui/textarea";
import { 
  Plus, Search, Filter, Package, Edit, Trash2, AlertTriangle, 
  ArrowUpDown, Download, Upload, MoreHorizontal
} from "lucide-react";
import { toast } from "sonner";
import ExportData from "@/components/tools/ExportData";
import BulkActions from "@/components/tools/BulkActions";
import InventoryAdjustment from "@/components/inventory/InventoryAdjustment";
import BarcodeLabelGenerator from "@/components/inventory/BarcodeLabelGenerator";
import LowStockAlerts from "@/components/inventory/LowStockAlerts";
import InventoryReports from "@/components/inventory/InventoryReports";

export default function Inventory() {
  const [search, setSearch] = useState('');
  const [categoryFilter, setCategoryFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [sortField, setSortField] = useState('name');
  const [sortDir, setSortDir] = useState('asc');
  const [showForm, setShowForm] = useState(false);
  const [editProduct, setEditProduct] = useState(null);
  const [showAdjustment, setShowAdjustment] = useState(false);
  const [adjustProduct, setAdjustProduct] = useState(null);
  const [showLabels, setShowLabels] = useState(false);
  const [selectedForLabels, setSelectedForLabels] = useState([]);
  const [showAlerts, setShowAlerts] = useState(false);
  const [showReports, setShowReports] = useState(false);
  const [selectedProducts, setSelectedProducts] = useState([]);
  const [formData, setFormData] = useState({
    name: '', sku: '', barcode: '', description: '', category: '',
    brand: '', current_stock: 0, reserved_stock: 0, reorder_point: 10, reorder_quantity: 50,
    unit_price: 0, selling_price: 0, supplier_id: '', supplier_name: '', location: '', 
    weight: 0, status: 'active',
    requires_lot_tracking: false,
    requires_serial_tracking: false,
    has_expiration: false,
    shelf_life_days: 0
  });

  const queryClient = useQueryClient();

  const { data: products = [], isLoading } = useQuery({
    queryKey: ['products'],
    queryFn: () => base44.entities.Product.list()
  });

  const { data: categories = [] } = useQuery({
    queryKey: ['categories'],
    queryFn: () => base44.entities.Category.list()
  });

  const { data: suppliers = [] } = useQuery({
    queryKey: ['suppliers'],
    queryFn: () => base44.entities.Supplier.list()
  });

  const activeCategories = categories.filter(c => c.status === 'active').map(c => c.name);
  const activeSuppliers = suppliers.filter(s => s.status === 'active');

  const createMutation = useMutation({
    mutationFn: (data) => base44.entities.Product.create(data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      setShowForm(false);
      resetForm();
      toast.success('Product created');
    }
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }) => base44.entities.Product.update(id, data),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      setShowForm(false);
      resetForm();
      toast.success('Product updated');
    }
  });

  const deleteMutation = useMutation({
    mutationFn: (id) => base44.entities.Product.delete(id),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['products'] });
      toast.success('Product deleted');
    }
  });

  const resetForm = () => {
    setEditProduct(null);
    setFormData({
      name: '', sku: '', barcode: '', description: '', category: '',
      brand: '', current_stock: 0, reserved_stock: 0, reorder_point: 10, reorder_quantity: 50,
      unit_price: 0, selling_price: 0, supplier_id: '', supplier_name: '', location: '', 
      weight: 0, status: 'active'
    });
  };

  const openEdit = (product) => {
    setEditProduct(product);
    setFormData({
      name: product.name || '',
      sku: product.sku || '',
      barcode: product.barcode || '',
      description: product.description || '',
      category: product.category || '',
      brand: product.brand || '',
      current_stock: product.current_stock || 0,
      reserved_stock: product.reserved_stock || 0,
      reorder_point: product.reorder_point || 10,
      reorder_quantity: product.reorder_quantity || 50,
      unit_price: product.unit_price || 0,
      selling_price: product.selling_price || 0,
      supplier_id: product.supplier_id || '',
      supplier_name: product.supplier_name || '',
      location: product.location || '',
      weight: product.weight || 0,
      status: product.status || 'active',
      requires_lot_tracking: product.requires_lot_tracking || false,
      requires_serial_tracking: product.requires_serial_tracking || false,
      has_expiration: product.has_expiration || false,
      shelf_life_days: product.shelf_life_days || 0
    });
    setShowForm(true);
  };

  const handleSupplierSelect = (supplierId) => {
    const supplier = suppliers.find(s => s.id === supplierId);
    if (supplier) {
      setFormData(p => ({ ...p, supplier_id: supplier.id, supplier_name: supplier.name }));
    }
  };

  const handleSave = () => {
    if (!formData.name || !formData.sku) {
      toast.error('Name and SKU are required');
      return;
    }
    if (editProduct) {
      updateMutation.mutate({ id: editProduct.id, data: formData });
    } else {
      createMutation.mutate(formData);
    }
  };

  const filteredProducts = useMemo(() => {
    let result = products.filter(p => {
      const matchSearch = p.name?.toLowerCase().includes(search.toLowerCase()) ||
                          p.sku?.toLowerCase().includes(search.toLowerCase());
      const matchCategory = categoryFilter === 'all' || p.category === categoryFilter;
      const matchStatus = statusFilter === 'all' || p.status === statusFilter;
      return matchSearch && matchCategory && matchStatus;
    });

    result.sort((a, b) => {
      const aVal = a[sortField] || '';
      const bVal = b[sortField] || '';
      if (sortDir === 'asc') return aVal > bVal ? 1 : -1;
      return aVal < bVal ? 1 : -1;
    });

    return result;
  }, [products, search, categoryFilter, statusFilter, sortField, sortDir]);

  const stats = {
    total: products.length,
    lowStock: products.filter(p => (p.current_stock || 0) <= (p.reorder_point || 0)).length,
    outOfStock: products.filter(p => (p.current_stock || 0) === 0).length,
    totalValue: products.reduce((sum, p) => sum + ((p.current_stock || 0) * (p.unit_price || 0)), 0)
  };

  return (
    <div className="p-6 space-y-6 bg-slate-100 min-h-screen">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-slate-900">Inventory</h1>
          <p className="text-sm text-slate-500">{products.length} products</p>
        </div>
        <div className="flex gap-2">
          <Button onClick={() => setShowAlerts(true)} variant="outline" size="sm">
            <AlertTriangle className="w-4 h-4 mr-2" />
            Alerts
          </Button>
          <Button onClick={() => setShowReports(true)} variant="outline" size="sm">
            Reports
          </Button>
          <ExportData data={filteredProducts} filename="inventory" />
          <BulkActions entityName="Product" onSuccess={() => queryClient.invalidateQueries({ queryKey: ['products'] })} />
          <Button onClick={() => { resetForm(); setShowForm(true); }} className="bg-slate-900 hover:bg-slate-800">
            <Plus className="w-4 h-4 mr-2" />
            Add Product
          </Button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="border-0 shadow-sm">
          <CardContent className="p-4">
            <p className="text-2xl font-bold">{stats.total}</p>
            <p className="text-xs text-slate-500">Total SKUs</p>
          </CardContent>
        </Card>
        <Card className="border-0 shadow-sm">
          <CardContent className="p-4">
            <p className="text-2xl font-bold text-amber-600">{stats.lowStock}</p>
            <p className="text-xs text-slate-500">Low Stock</p>
          </CardContent>
        </Card>
        <Card className="border-0 shadow-sm">
          <CardContent className="p-4">
            <p className="text-2xl font-bold text-red-600">{stats.outOfStock}</p>
            <p className="text-xs text-slate-500">Out of Stock</p>
          </CardContent>
        </Card>
        <Card className="border-0 shadow-sm">
          <CardContent className="p-4">
            <p className="text-2xl font-bold">${stats.totalValue.toLocaleString()}</p>
            <p className="text-xs text-slate-500">Total Value</p>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card className="border-0 shadow-sm">
        <CardContent className="p-4">
          <div className="flex flex-col lg:flex-row gap-4">
            <div className="flex-1 relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
              <Input
                placeholder="Search by name or SKU..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="pl-10"
              />
            </div>
            <Select value={categoryFilter} onValueChange={setCategoryFilter}>
              <SelectTrigger className="w-full lg:w-40">
                <SelectValue placeholder="Category" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Categories</SelectItem>
                {activeCategories.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
              </SelectContent>
            </Select>
            <Select value={statusFilter} onValueChange={setStatusFilter}>
              <SelectTrigger className="w-full lg:w-36">
                <SelectValue placeholder="Status" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="all">All Status</SelectItem>
                <SelectItem value="active">Active</SelectItem>
                <SelectItem value="out_of_stock">Out of Stock</SelectItem>
                <SelectItem value="discontinued">Discontinued</SelectItem>
              </SelectContent>
            </Select>
          </div>
        </CardContent>
      </Card>

      {/* Products Table */}
      <Card className="border-0 shadow-sm">
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-50 border-b">
                <tr>
                  <th className="text-left p-4 text-xs font-medium text-slate-500 uppercase">
                    <input
                      type="checkbox"
                      checked={selectedProducts.length === filteredProducts.length && filteredProducts.length > 0}
                      onChange={(e) => {
                        if (e.target.checked) {
                          setSelectedProducts(filteredProducts.map(p => p.id));
                        } else {
                          setSelectedProducts([]);
                        }
                      }}
                      className="rounded"
                    />
                  </th>
                  <th className="text-left p-4 text-xs font-medium text-slate-500 uppercase">Product</th>
                  <th className="text-left p-4 text-xs font-medium text-slate-500 uppercase">SKU</th>
                  <th className="text-left p-4 text-xs font-medium text-slate-500 uppercase">Category</th>
                  <th className="text-right p-4 text-xs font-medium text-slate-500 uppercase">Stock</th>
                  <th className="text-right p-4 text-xs font-medium text-slate-500 uppercase">Cost</th>
                  <th className="text-right p-4 text-xs font-medium text-slate-500 uppercase">Price</th>
                  <th className="text-left p-4 text-xs font-medium text-slate-500 uppercase">Status</th>
                  <th className="text-right p-4 text-xs font-medium text-slate-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y">
                {filteredProducts.map((product) => {
                  const isLow = (product.current_stock || 0) <= (product.reorder_point || 0);
                  const isSelected = selectedProducts.includes(product.id);
                  return (
                    <tr key={product.id} className="hover:bg-slate-50">
                      <td className="p-4">
                        <input
                          type="checkbox"
                          checked={isSelected}
                          onChange={(e) => {
                            if (e.target.checked) {
                              setSelectedProducts([...selectedProducts, product.id]);
                            } else {
                              setSelectedProducts(selectedProducts.filter(id => id !== product.id));
                            }
                          }}
                          className="rounded"
                        />
                      </td>
                      <td className="p-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-slate-100 rounded flex items-center justify-center">
                            <Package className="w-5 h-5 text-slate-400" />
                          </div>
                          <div>
                            <p className="font-medium text-slate-900">{product.name}</p>
                            <div className="flex gap-1 mt-1">
                              {product.requires_lot_tracking && <Badge variant="outline" className="text-xs">Lot</Badge>}
                              {product.requires_serial_tracking && <Badge variant="outline" className="text-xs">Serial</Badge>}
                              {product.has_expiration && <Badge variant="outline" className="text-xs text-amber-600">Exp</Badge>}
                            </div>
                          </div>
                        </div>
                      </td>
                      <td className="p-4">
                        <code className="text-sm bg-slate-100 px-2 py-0.5 rounded">{product.sku}</code>
                      </td>
                      <td className="p-4 text-sm text-slate-600">{product.category || 'â€”'}</td>
                      <td className="p-4 text-right">
                        <div className="flex items-center justify-end gap-2">
                          {isLow && <AlertTriangle className="w-4 h-4 text-amber-500" />}
                          <span className={`font-medium ${isLow ? 'text-amber-600' : ''}`}>
                            {product.current_stock || 0}
                          </span>
                        </div>
                      </td>
                      <td className="p-4 text-right text-sm">${product.unit_price || 0}</td>
                      <td className="p-4 text-right text-sm font-medium">${product.selling_price || 0}</td>
                      <td className="p-4">
                        <Badge variant="outline" className={
                          product.status === 'active' ? 'border-emerald-200 text-emerald-700' :
                          product.status === 'out_of_stock' ? 'border-red-200 text-red-700' :
                          'border-slate-200 text-slate-600'
                        }>
                          {product.status || 'active'}
                        </Badge>
                      </td>
                      <td className="p-4 text-right">
                        <div className="flex items-center justify-end gap-1">
                          <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => {
                            setAdjustProduct(product);
                            setShowAdjustment(true);
                          }}>
                            <Package className="w-4 h-4" />
                          </Button>
                          <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => openEdit(product)}>
                            <Edit className="w-4 h-4" />
                          </Button>
                          <Button variant="ghost" size="icon" className="h-8 w-8 text-red-500" onClick={() => deleteMutation.mutate(product.id)}>
                            <Trash2 className="w-4 h-4" />
                          </Button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
            {filteredProducts.length === 0 && (
              <div className="p-8 text-center text-slate-500">
                {isLoading ? 'Loading...' : 'No products found'}
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Bulk Actions Bar */}
      {selectedProducts.length > 0 && (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-4 z-50">
          <span className="font-medium">{selectedProducts.length} selected</span>
          <Button 
            size="sm" 
            variant="secondary"
            onClick={() => {
              const selected = products.filter(p => selectedProducts.includes(p.id));
              setSelectedForLabels(selected);
              setShowLabels(true);
            }}
          >
            Generate Labels
          </Button>
          <Button 
            size="sm" 
            variant="secondary"
            onClick={() => setSelectedProducts([])}
          >
            Clear
          </Button>
        </div>
      )}

      {/* Dialogs */}
      <InventoryAdjustment 
        open={showAdjustment} 
        onOpenChange={setShowAdjustment}
        product={adjustProduct}
      />
      <BarcodeLabelGenerator
        open={showLabels}
        onOpenChange={setShowLabels}
        products={selectedForLabels}
      />
      <LowStockAlerts
        open={showAlerts}
        onOpenChange={setShowAlerts}
      />
      <InventoryReports
        open={showReports}
        onOpenChange={setShowReports}
      />

      {/* Product Form Dialog */}
      <Dialog open={showForm} onOpenChange={setShowForm}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>{editProduct ? 'Edit Product' : 'New Product'}</DialogTitle>
          </DialogHeader>
          <div className="grid gap-4 mt-4">
            <div className="grid grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>Name *</Label>
                <Input value={formData.name} onChange={(e) => setFormData(p => ({ ...p, name: e.target.value }))} />
              </div>
              <div className="space-y-2">
                <Label>SKU *</Label>
                <Input value={formData.sku} onChange={(e) => setFormData(p => ({ ...p, sku: e.target.value }))} />
              </div>
              <div className="space-y-2">
                <Label>Barcode</Label>
                <Input value={formData.barcode} onChange={(e) => setFormData(p => ({ ...p, barcode: e.target.value }))} placeholder="UPC/EAN" />
              </div>
            </div>
            <div className="space-y-2">
              <Label>Description</Label>
              <Textarea value={formData.description} onChange={(e) => setFormData(p => ({ ...p, description: e.target.value }))} rows={2} />
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>Category</Label>
                <Select value={formData.category} onValueChange={(v) => setFormData(p => ({ ...p, category: v }))}>
                  <SelectTrigger><SelectValue placeholder="Select category" /></SelectTrigger>
                  <SelectContent>
                    {activeCategories.map(c => <SelectItem key={c} value={c}>{c}</SelectItem>)}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Brand</Label>
                <Input value={formData.brand} onChange={(e) => setFormData(p => ({ ...p, brand: e.target.value }))} />
              </div>
              <div className="space-y-2">
                <Label>Status</Label>
                <Select value={formData.status} onValueChange={(v) => setFormData(p => ({ ...p, status: v }))}>
                  <SelectTrigger><SelectValue /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="active">Active</SelectItem>
                    <SelectItem value="out_of_stock">Out of Stock</SelectItem>
                    <SelectItem value="discontinued">Discontinued</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="grid grid-cols-4 gap-4">
              <div className="space-y-2">
                <Label>Current Stock</Label>
                <Input type="number" value={formData.current_stock} onChange={(e) => setFormData(p => ({ ...p, current_stock: parseInt(e.target.value) || 0 }))} />
              </div>
              <div className="space-y-2">
                <Label>Reserved</Label>
                <Input type="number" value={formData.reserved_stock} onChange={(e) => setFormData(p => ({ ...p, reserved_stock: parseInt(e.target.value) || 0 }))} />
              </div>
              <div className="space-y-2">
                <Label>Reorder Point</Label>
                <Input type="number" value={formData.reorder_point} onChange={(e) => setFormData(p => ({ ...p, reorder_point: parseInt(e.target.value) || 0 }))} />
              </div>
              <div className="space-y-2">
                <Label>Reorder Qty</Label>
                <Input type="number" value={formData.reorder_quantity} onChange={(e) => setFormData(p => ({ ...p, reorder_quantity: parseInt(e.target.value) || 0 }))} />
              </div>
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>Unit Cost ($)</Label>
                <Input type="number" step="0.01" value={formData.unit_price} onChange={(e) => setFormData(p => ({ ...p, unit_price: parseFloat(e.target.value) || 0 }))} />
              </div>
              <div className="space-y-2">
                <Label>Selling Price ($)</Label>
                <Input type="number" step="0.01" value={formData.selling_price} onChange={(e) => setFormData(p => ({ ...p, selling_price: parseFloat(e.target.value) || 0 }))} />
              </div>
              <div className="space-y-2">
                <Label>Weight (lbs)</Label>
                <Input type="number" step="0.01" value={formData.weight} onChange={(e) => setFormData(p => ({ ...p, weight: parseFloat(e.target.value) || 0 }))} />
              </div>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Supplier</Label>
                <Select value={formData.supplier_id} onValueChange={handleSupplierSelect}>
                  <SelectTrigger><SelectValue placeholder="Select supplier" /></SelectTrigger>
                  <SelectContent>
                    {activeSuppliers.map(s => <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>)}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Location</Label>
                <Input value={formData.location} onChange={(e) => setFormData(p => ({ ...p, location: e.target.value }))} placeholder="e.g., A-01-03" />
              </div>
              </div>
              <div className="space-y-3">
              <Label className="font-semibold">Advanced Tracking</Label>
              <div className="flex items-center gap-4">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.requires_lot_tracking}
                    onChange={(e) => setFormData(p => ({ ...p, requires_lot_tracking: e.target.checked }))}
                    className="rounded"
                  />
                  <span className="text-sm">Lot Tracking</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.requires_serial_tracking}
                    onChange={(e) => setFormData(p => ({ ...p, requires_serial_tracking: e.target.checked }))}
                    className="rounded"
                  />
                  <span className="text-sm">Serial Tracking</span>
                </label>
                <label className="flex items-center gap-2 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={formData.has_expiration}
                    onChange={(e) => setFormData(p => ({ ...p, has_expiration: e.target.checked }))}
                    className="rounded"
                  />
                  <span className="text-sm">Has Expiration</span>
                </label>
              </div>
              {formData.has_expiration && (
                <div className="space-y-2">
                  <Label>Shelf Life (days)</Label>
                  <Input
                    type="number"
                    value={formData.shelf_life_days}
                    onChange={(e) => setFormData(p => ({ ...p, shelf_life_days: parseInt(e.target.value) || 0 }))}
                  />
                </div>
              )}
              </div>
              <div className="flex gap-3 pt-4 border-t">
              <Button variant="outline" onClick={() => setShowForm(false)} className="flex-1">Cancel</Button>
              <Button onClick={handleSave} className="flex-1 bg-slate-900 hover:bg-slate-800">
                {editProduct ? 'Update' : 'Create'}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
